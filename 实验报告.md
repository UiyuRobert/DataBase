## 任务一 ：建表、完善约束

### `Student` 表

#### 内容

|  字段名   |     类型      |     约束      |
| :-------: | :-----------: | :-----------: |
|   `Sid`   |   `char(8)`   | `PRIMARY KEY` |
|  `Sname`  | `varchar(20)` |  `NOT NULL`   |
| `Sgender` | `varchar(2)`  |  `NOT NULL`   |
|  `Sage`   |   `int(4)`    |  `NOT NULL`   |

#### 约束 `SQL`

- `Sid` 八位纯数字约束：

  ```sql
  DELIMITER $
  CREATE TRIGGER check_sid_isnum 
  BEFORE INSERT ON Student 
  FOR EACH ROW 
  BEGIN
      IF NEW.Sid NOT REGEXP '^[0-9]{8}$' THEN
          SIGNAL SQLSTATE '45000' 
          SET MESSAGE_TEXT = 'Sid must be 8 digits';
      END IF;
  END$
  DELIMITER ;
  ```

  效果：

  ![八位纯数字约束](./assets/%E6%88%AA%E5%9B%BE%202024-10-01%2011-46-54.png)

- `Sage` 必须大于 0 且小于等于 200约束：

  ```sql
  DELIMITER $
  CREATE TRIGGER check_sage_isright
  BEFORE INSERT ON Student 
  FOR EACH ROW 
  BEGIN
      IF NEW.Sage <= 0 OR NEW.Sage > 200 THEN
          SIGNAL SQLSTATE '45000' 
          SET MESSAGE_TEXT = 'illegal age';
      END IF;
  END$
  DELIMITER ;
  ```

  效果：

  ![Sage](./assets/%E6%88%AA%E5%9B%BE%202024-10-01%2011-46-54-1727758843568-2.png)

### `Course` 表

#### 内容

|  字段名   |     类型      |     约束      |
| :-------: | :-----------: | :-----------: |
|   `Cid`   |   `char(8)`   | `PRIMARY KEY` |
|  `Cname`  | `varchar(30)` |  `NOT NULL`   |
|  `Ctype`  | `varchar(10)` |  `NOT NULL`   |
| `Ccredit` |   `tinyint`   |  `NOT NULL`   |
|   `Tid`   |   `char(9)`   | `FOREIGN KEY` |

#### 约束

- `Cid` 固定八位纯数字：

  ```sql
  DELIMITER $
  CREATE TRIGGER check_cid_isnum 
  BEFORE INSERT ON Course 
  FOR EACH ROW 
  BEGIN
      IF NEW.Cid NOT REGEXP '^[0-9]{8}$' THEN
          SIGNAL SQLSTATE '45000' 
          SET MESSAGE_TEXT = 'Cid must be 8 digits';
      END IF;
  END$
  DELIMITER ;
  ```

- `Ccredit` 范围约束：

  ```sql
  DELIMITER $
  CREATE TRIGGER check_credit_isright
  BEFORE INSERT ON Course
  FOR EACH ROW 
  BEGIN
      IF NEW.Ccredit < 0 OR NEW.Ccredit > 99 THEN
          SIGNAL SQLSTATE '45000' 
          SET MESSAGE_TEXT = 'illegal credit';
      END IF;
  END$
  DELIMITER ;
  ```

  

### `Teacher` 表

#### 内容

|  字段名   |      类型      |     约束      |
| :-------: | :------------: | :-----------: |
|   `Tid`   |   `char(9)`    | `PRIMARY KEY` |
|  `Tname`  | `varchar(20)`  |  `NOT NULL`   |
| `Tgender` |  `varchar(2)`  |  `NOT NULL`   |
|  `Tage`   |   `smallint`   |  `NOT NULL`   |
| `Temail`  | `varchar(127)` |               |
| `Tphone`  | `varchar(30)`  |   `UNIQUE`    |

#### 约束

- `Tid` 九位纯数字约束：

  ```sql
  DELIMITER $
  CREATE TRIGGER check_Tid_isnum 
  BEFORE INSERT ON Teacher 
  FOR EACH ROW 
  BEGIN
      IF NEW.Tid NOT REGEXP '^[0-9]{9}$' THEN
          SIGNAL SQLSTATE '45000' 
          SET MESSAGE_TEXT = 'Tid must be 9 digits';
      END IF;
  END$
  DELIMITER ;
  ```

  效果：![image-20241001133859940](./assets/image-20241001133859940.png)

- `Tage` 约束：

  ```sql
  DELIMITER $
  CREATE TRIGGER check_tage_isright
  BEFORE INSERT ON Student 
  FOR EACH ROW 
  BEGIN
      IF NEW.Tage <= 0 OR NEW.Tage > 200 THEN
          SIGNAL SQLSTATE '45000' 
          SET MESSAGE_TEXT = 'illegal age';
      END IF;
  END$
  DELIMITER ;
  ```

- `Tphone` 唯一约束：

  ```sql
  ALTER TABLE Teacher
  ADD CONSTRAINT unique_phone UNIQUE (Tphone);
  ```


### `SC` 表

#### 内容

| 字段名  |   类型    |     约束      |
| :-----: | :-------: | :-----------: |
|  `Sid`  | `char(8)` | `FOREIGN KEY` |
|  `Cid`  | `char(8)` | `FOREIGN KEY` |
| `Score` | `tinyint` |               |

#### 约束

- `Score` 不可超过 100，不可为负

  ```sql
  DELIMITER $
  CREATE TRIGGER check_score
  BEFORE INSERT ON SC
  FOR EACH ROW
  BEGIN
  	IF NEW.Score < 0 OR NEW.Score > 100 THEN
  		SIGNAL SQLSTATE '45000' 
  		SET MESSAGE_TEXT = 'illegal score';
  	END IF;
  END$
  DELIMITER ;
  
  DELIMITER $
  CREATE TRIGGER check_score_update
  BEFORE UPDATE ON SC
  FOR EACH ROW
  BEGIN
  	IF NEW.Score < 0 OR NEW.Score > 100 THEN
  		SIGNAL SQLSTATE '45000' 
  		SET MESSAGE_TEXT = 'illegal score';
  	END IF;
  END$
  DELIMITER ;
  ```

## 任务二：插入数据

#### 云数据库的特性

- 形象的图形化界面，操作方便
- 可以通过第三方提供的软件支持，对数据库进行监控和性能优化
- 安全程度高，有各种加密以及身份验证、访问控制
- 云数据库由云服务商进行维护，简化了用户的运维工作

#### 分布式数据库的特性

- 数据分片：通过将数据分片（分区）存储在不同的节点上来提高性能。每个节点处理部分数据集的存储和查询任务，从而降低了单个节点的负载，并提高了并发处理能力
- 横向拓展：分布式数据库可以通过添加更多节点来增加处理能力，而不是依赖于单一的高性能机器。这种横向扩展使系统能够处理更大的数据量和更高的并发负载
- 分布式数据库通过数据复制和多副本机制提供容错和高可用性。即使某些节点出现故障，其他节点可以继续处理请求，确保数据库的正常运行

## 任务三：查询数据

### 查询所有数据

#### `teacher` 表

![image-20241001172938222](./assets/image-20241001172938222.png)

#### `sc` 表

![image-20241001173052715](./assets/image-20241001173052715.png)

#### `course` 表

![image-20241001173009515](./assets/image-20241001173009515.png)

#### `student` 表

![image-20241001173102001](./assets/image-20241001173102001.png)

### 自定义查询

#### 查询性别为男的教师教授的学分不少于5的课程中，成绩在80分以上的学生的姓名

- `sql`：

  ```sql
  SELECT sc.Sid, sc.Cid, sc.Score , teacher.Tname 
  FROM sc
  JOIN student ON sc.Sid = student.Sid 
  JOIN course ON sc.Cid = course.Cid 
  JOIN teacher ON course.Tid = teacher.Tid 
  WHERE teacher.Tgender = '男' AND course.Ccredit >= 5 AND sc.Score > 80;
  ```

- 结果：![](./assets/%E6%88%AA%E5%9B%BE%202024-10-01%2017-59-11.png)





















